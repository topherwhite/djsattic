<?phprequire '../includes/DirectoryRelated.inc';require '../includes/UploadFileManip.inc';require '../includes/MySQL_Sessions.inc';require '../includes/TableRelated.inc';session_start();	if (empty($_SESSION['idnum']))	{ header("Location: http://www.mysimum.com/"); exit; }$key = mktime();$idnum[0] = $_SESSION['idnum'];$idnum[1] = dechex($idnum[0]);$ImgRank = $_GET['refnum'];$TbleGrp = GenerateTableGroup($idnum[0]);$NxtImg = $_GET['nxtimg'];$ImgDir =  "/cluster/harry/img/photo/" . GenerateFullImageDirectoryPath($idnum[0]);if (!($connection = @mysql_connect($sqlserver,$sqlusername,$sqluserpswd)))		die("Could not connect to database");	if (!(mysql_select_db($databasename,$connection)))		showerror();	$mysqlidnum = mysqlclean($idnum, 0, 8, $connection);$mysqlImgRank = mysqlclean($_GET, 'refnum', 4, $connection);$query['GetFileName'] =	'SELECT type, file, ext ' 					.	'FROM ' . $TbleGrp['uploads'] . ' '					.	"WHERE rank = '" . $mysqlImgRank . "'"					;if ($FileName = @mysql_fetch_array(@mysql_query ($query['GetFileName'], $connection))){if ($FileName['type'] == 'img'){	$query['DeleteInfoRow'] = 	'DELETE FROM ' . $TbleGrp['uploads'] . ' '							.	"WHERE rank = '" . $mysqlImgRank . "'"							;	$query['UpdateImgCount'] = 	"UPDATE filecount "							.	"SET numpics = numpics - 1 "							.	"WHERE idnum = '{$mysqlidnum}'"							;	$query['SearchItemTble'] =	"SELECT * FROM items "							.	"WHERE idnum = '{$mysqlidnum}'"							;		if ($ItemArray = @mysql_fetch_array(@mysql_query ($query['SearchItemTble'], $connection)))	{//		Set default existence status		$ExistsAt = 'NOWHERE';			for($colrep = 0; $colrep < 4; $colrep++)				{	for($itmrep = 0; $itmrep < 8; $itmrep++)					{	$AttribName = 'c' . $colrep . 'i' . $itmrep;					if ($ItemArray[$AttribName] == $ImgRank)	$ExistsAt = $AttribName;			}	}				if ($ExistsAt == 'NOWHERE')		{	if (@mysql_query ($query['DeleteInfoRow'], $connection))			{	if (@mysql_query ($query['UpdateImgCount'], $connection))				{				$FullFileName = $idnum[0] .".". $FileName['file'] .".". $FileName['ext'];				exec(DeleteUploadedFile($ImgDir,$FullFileName,'img'));				$HeaderInfo = "sess=" . session_id() . '&' . "key={$key}" . '&' . "status=2del" . '&' . "nxtimg=" . $_GET['nxtimg'];		}	}	}				if ($ExistsAt != 'NOWHERE')		{	$query['UpdateItemTble'] =	"UPDATE items "									.	"SET {$ExistsAt} = 0 "									.	"WHERE idnum = '{$mysqlidnum}'"									;						if (@mysql_query ($query['UpdateItemTble'], $connection))			{	if (@mysql_query ($query['DeleteInfoRow'], $connection))				{	if (@mysql_query ($query['UpdateImgCount'], $connection))					{					exec(DeleteUploadedFile($ImgDir,$FileName['file'],'img'));										$HeaderInfo = "sess=" . session_id() . '&' . "key={$key}" . '&' . "status=3del" . '&' . "nxtimg=" . $_GET['nxtimg'];		}	}	}	}			}}else	$HeaderInfo = "sess=" . session_id() . '&' . "key={$key}" . '&' . "status=0del" . '&' . "nxtimg={$_GET['nxtimg']}";}else	$HeaderInfo = "sess=" . session_id() . '&' . "key={$key}" . '&' . "status=0del" . '&' . "nxtimg={$_GET['nxtimg']}";	header("Location: ../user/img_gallery.php?{$HeaderInfo}");exit;?>