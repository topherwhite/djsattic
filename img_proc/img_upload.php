<?phprequire '../includes/mySQL_Sessions.inc';require '../includes/GetFileExtension.inc';require '../includes/UploadFileManip.inc';require '../includes/DirectoryRelated.inc';require '../includes/TableRelated.inc';session_start();	if (empty($_SESSION['idnum']))	{ header("Location: http://www.mysimum.com/"); exit; }$idnum[0] = $_SESSION['idnum'];$idnum[1] = dechex($idnum[0]);$sess_id = session_id();$key = mktime();$RtrnHeader = 'Location: ../user/img_gallery.php?sess=' . $sess_id . '&key=' . $key . '&img=' . $_GET['img'];if (empty($_FILES['ImgFile']['name'])){		$_SESSION['status'] = 'nofile';		header($RtrnHeader);	exit;	}if (!(empty($_FILES['ImgFile']['name']))){	$pext = getFileExtension($_FILES['ImgFile']['name']);	$pext = strtolower($pext);	if (($pext != "jpg")  && ($pext != "jpeg"))		{	unlink($_FILES['ImgFile']['tmp_name']);		$_SESSION['status'] = 'wrngext';		header($RtrnHeader);	exit;	}	$UploadDir = "/cluster/harry/img/photo/" . GenerateFullImageDirectoryPath($idnum[0]);	$FileName = "{$idnum[0]}.{$key}.jpg";		$UploadFile = $UploadDir . "drop/" . $FileName;	$OrigFile = $UploadDir . "orig." . $FileName;	$LargeFile = $UploadDir . "lrg." . $FileName;	$TbleGrp = GenerateTableGroup($idnum[0]);		if (move_uploaded_file($_FILES['ImgFile']['tmp_name'], $UploadFile))			{						$sh_Rename = "mv " . $UploadFile . " " . $OrigFile;			exec($sh_Rename);			ResizeImageFile( $OrigFile , $LargeFile , 640 , 80 );									$TargetFile = $UploadDir . "med." . $FileName;			ResizeImageFile( $LargeFile , $TargetFile , 460 , 80 );			$TargetFile = $UploadDir . "sml." . $FileName;			ResizeImageFile( $LargeFile , $TargetFile , 336 , 70 );			$TargetFile = $UploadDir . "thmb." . $FileName;			ResizeImageFile( $LargeFile , $TargetFile , 240 , 70 );			$TargetFile = $UploadDir . "mini." . $FileName;			ResizeImageFile( $LargeFile , $TargetFile , 180 , 70 );			$TargetFile = $UploadDir . "edit." . $FileName;			ResizeImageFile( $LargeFile , $TargetFile , 120 , 50 );						$sh_SetPerm =	"chmod a+rw " . $UploadDir . "lrg." . $FileName					."\n".	"chmod a+rw " . $UploadDir . "med." . $FileName					."\n".	"chmod a+rw " . $UploadDir . "sml." . $FileName					."\n".	"chmod a+rw " . $UploadDir . "thmb." . $FileName					."\n".	"chmod a+rw " . $UploadDir . "mini." . $FileName					."\n".	"chmod a+rw " . $UploadDir . "edit." . $FileName					."\n".	"chmod a+rw " . $UploadDir . "orig." . $FileName					;			exec($sh_SetPerm);						$query['StoreImage'] = "INSERT INTO {$TbleGrp['uploads']} VALUES ('',{$idnum[0]},'img',{$key},'','','',0,0,'jpg')";			$query['UpdateImageCounter'] = "UPDATE filecount SET numpics = numpics + 1 WHERE idnum = '{$idnum[0]}'";			$query['GetRefNum'] = "SELECT rank FROM {$TbleGrp['uploads']} WHERE idnum = {$idnum[0]} AND file = '{$key}'";						if (@mysql_query ($query['StoreImage'], $connection))			{	if (@mysql_query ($query['UpdateImageCounter'], $connection))				{	if ($RefNum = @mysql_fetch_array(@mysql_query ($query['GetRefNum'], $connection)))					{					$_SESSION['status'] = 'uplsucc';					$HeaderInfo = "sess=" . $sess_id . "&refnum={$RefNum['rank']}&key={$key}";			}	}	}						header("Location: ../user/img_gallery.php?{$HeaderInfo}");			exit;						}	else	{	$_SESSION['status'] = 'uplfail';	header($RtrnHeader);	exit;	}}?>