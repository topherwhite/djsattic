<?phprequire '../includes/MySQL_Sessions.inc';require '../includes/TableRelated.inc';require '../includes/UploadFileManip.inc';require '../includes/DirectoryRelated.inc';session_start();	if (empty($_SESSION['idnum']))	{ die("No User Specified"); }$idnum[0] = $_SESSION['idnum'];$sess_id = session_id();$key = mktime();$TbleGrp = GenerateTableGroup($idnum[0]);$do = mysqlclean($_GET,'do',4,$connection);if		($do == 'chng'){	$_SESSION['curr_alb'] = mysqlclean($_GET,'refnum',8,$connection);	header("Location: album_select.php?sess={$sess_id}&key={$key}&m=alch");	exit;}elseif	($do == 'make'){	$query['UpdateCount'] = "UPDATE filecount SET imglists=imglists+1 WHERE idnum={$idnum[0]}";	$query['CreateAlbum'] = "INSERT INTO {$TbleGrp['lists']} SET idnum={$idnum[0]}, type='img', title='Untitled Album', created={$key}";	$query['GetLastID'] = "SELECT MAX(rank) AS last FROM {$TbleGrp['lists']} WHERE idnum={$idnum[0]} AND type='img'";	if (@mysql_query($query['UpdateCount'], $connection))	{	if (@mysql_query($query['CreateAlbum'], $connection))		{	if ($id = @mysql_fetch_array(@mysql_query($query['GetLastID'], $connection)))			{			$_SESSION['curr_alb'] = $id['last'];			header("Location: album_select.php?sess={$sess_id}&key={$key}&m=alcr");			exit;	}	}	}}elseif	($do == 'dlal'){	$query['GetAlbum'] = "SELECT itm1";		for ($i = 2; $i <= 50; $i++)	$query['GetAlbum'] .= ", itm{$i}";		$query['GetAlbum'] .= " FROM {$TbleGrp['lists']} WHERE rank={$_SESSION['curr_alb']}";	$query['UpdateImgCount'] =	"UPDATE filecount SET numpics=numpics-1 WHERE idnum={$idnum[0]}";		if ($Itms = @mysql_fetch_array(@mysql_query($query['GetAlbum'], $connection)))	{	for ($i = 1; $i <= 50; $i++)		{	$name = "itm".$i;			if (!(empty($Itms[$name])))			{	$query['GetFileName'] = "SELECT file, ext FROM {$TbleGrp['uploads']} WHERE rank={$Itms[$name]}";				$query['DeletePhoto'] = "DELETE FROM {$TbleGrp['uploads']} WHERE rank={$Itms[$name]}";				if ($Name = @mysql_fetch_array(@mysql_query($query['GetFileName'], $connection)))				{	if (@mysql_query($query['DeletePhoto'], $connection))					{	if (@mysql_query($query['UpdateImgCount'], $connection))						{	$dir = "/cluster/harry/img/photo/" . GenerateFullImageDirectoryPath($idnum[0]);							$file = "{$idnum[0]}.{$Name['file']}.{$Name['ext']}";							exec(DeleteUploadedFile($dir,$file,'img'));				}	}	}	}	}	}	$query['GetRank'] = "SELECT rank FROM {$TbleGrp['uploads']} WHERE idnum={$idnum[0]} AND type='alb' AND file={$_SESSION['curr_alb']} LIMIT 1";	$query['CheckPage'] = "SELECT * FROM items WHERE idnum={$idnum[0]}";	if ($rnk = @mysql_fetch_array(@mysql_query($query['GetRank'], $connection)))	{	if ($itm = @mysql_fetch_array(@mysql_query($query['CheckPage'], $connection)))		{	for ($cl = 0; $cl <= 3; $cl++)			{	for ($it = 0; $it <= 7; $it++)				{	$name = "c{$cl}i{$it}";					if ($itm[$name] == $rnk['rank'])					{	$query['Shffle'] = "UPDATE items SET ";						for ($i = $it; $i <= 6; $i++)						{	$n = $i+1;							$query['Shffle'] .= "c{$cl}i{$i}=c{$cl}i{$n}";							if ($n != 7)	$query['Shffle'] .= ",";						}						$query['Shffle'] .= " WHERE idnum={$idnum[0]}";						@mysql_query($query['Shffle'],$connection);		}	}	}	}		$query['DelItm'] = "DELETE FROM {$TbleGrp['uploads']} WHERE idnum={$idnum[0]} AND type='alb' AND file={$_SESSION['curr_alb']}";		@mysql_query($query['DelItm'],$connection);	}	$query['UpdateCount'] =	"UPDATE filecount SET imglists=imglists-1 WHERE idnum={$idnum[0]}";	$query['DeleteAlbum'] =	"DELETE FROM {$TbleGrp['lists']} WHERE rank={$_SESSION['curr_alb']}";	if (@mysql_query($query['UpdateCount'], $connection))	{	if (@mysql_query($query['DeleteAlbum'], $connection))		{	$query['FirstAlbum'] = "SELECT rank FROM {$TbleGrp['lists']} WHERE idnum={$idnum[0]} AND type='img' LIMIT 1";			if ($Album = @mysql_fetch_array(@mysql_query($query['FirstAlbum'],$connection)))			{	$_SESSION['curr_alb'] = $Album['rank'];				header("Location: album_select.php?sess={$sess_id}&key={$key}&m=aldl");				exit;			}			else			{	header("Location: album_select.php?sess={$sess_id}&key={$key}&m=aldl");				exit;			}	}	}}elseif	($do == 'dlph'){	$SongToRemove = mysqlclean($_GET,'refnum',8,$connection);	$num = intval(ereg_replace('\'', '`', $_GET['num'])) - 1;	$query['CheckList'] = "SELECT itm1";		for ($i = 2; $i <= 50; $i++)	$query['CheckList'] .= ",itm".$i;	$query['CheckList'] .= " FROM {$TbleGrp['lists']} WHERE rank = {$_SESSION['curr_alb']}";	if ($ListItms = @mysql_fetch_array(@mysql_query($query['CheckList'], $connection)))	{	for ($cntr = 1; $cntr <= 50; $cntr++)		{	$name = "itm" . $cntr;			if ($ListItms[$name] == $SongToRemove)				$RemoveFrom = $cntr;			}		if (empty($RemoveFrom))			die("not there");		elseif ($RemoveFrom < 50)		{	$query['ReOrg'] .= "UPDATE {$TbleGrp['lists']} SET";			for ($cntr = $RemoveFrom; $cntr < 50; $cntr++)			{	$query['ReOrg'] .= " itm{$cntr}=itm" . ($cntr+1);				if ($cntr < 49)	$query['ReOrg'] .= ",";			}			$query['ReOrg'] .= " WHERE rank={$_SESSION['curr_alb']}";			@mysql_query($query['ReOrg'], $connection);		}		else		{	$query['RemoveSong'] = "UPDATE {$TbleGrp['lists']} SET itm{$RemoveFrom}=0 WHERE rank={$_SESSION['curr_alb']}";			if (@mysql_query($query['RemoveSong'], $connection))			$status = "succ";	}	}		$query['GetFileName'] = "SELECT file,ext FROM {$TbleGrp['uploads']} WHERE rank={$SongToRemove}";	$query['UpdateImgCount'] =	"UPDATE filecount SET numpics=numpics-1 WHERE idnum={$idnum[0]}";		$query['DeletePhoto'] = "DELETE FROM {$TbleGrp['uploads']} WHERE rank={$SongToRemove}";	if ($Name = @mysql_fetch_array(@mysql_query($query['GetFileName'], $connection)))	{	if (@mysql_query($query['DeletePhoto'], $connection))		{	if (@mysql_query($query['UpdateImgCount'], $connection))			{	$dir = "/cluster/harry/img/photo/" . GenerateFullImageDirectoryPath($idnum[0]);				$file = "{$idnum[0]}.{$Name['file']}.{$Name['ext']}";				exec(DeleteUploadedFile($dir,$file,'img'));				header("Location: ../img/mainalbum.php?sess={$sess_id}&num={$num}");				exit;	}	}	}}/*elseif	(($do == 'mvU') || ($do == 'mvD')){	$SongToMove = mysqlclean($_GET,'refnum',8,$connection);	$query['CheckList'] = "SELECT itm1,itm2,itm3,itm4,itm5,itm6,itm7,itm8,itm9,itm10"					.	",itm11,itm12,itm13,itm14,itm15,itm16,itm17,itm18,itm19,itm20"					.	" FROM {$TbleGrp['lists']} WHERE rank = {$_SESSION['curr_list']}";	if ($ListItms = @mysql_fetch_array(@mysql_query ($query['CheckList'], $connection)))	{	for ($cntr = 1; $ListItms[$name] != $SongToMove; $cntr++)		{	$name = "itm{$cntr}";			if ($ListItms[$name] == $SongToMove)			{	if (($do == 'mvU') && ($cntr != 1))		$dest = "itm" . ($cntr-1);				elseif (($do == 'mvD') && ($cntr != 20))	$dest = "itm" . ($cntr+1);				$query['Move'] = "UPDATE {$TbleGrp['lists']} SET {$name}={$dest}, {$dest}={$SongToMove} WHERE rank={$_SESSION['curr_list']}";	}	}	}		if (!(empty($query['Move'])))	{	if (@mysql_query ($query['Move'], $connection))			$status = "moved";	}	header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&m=p{$do}");	exit;}*//*elseif	($do == 'add'){	$SongToAdd = mysqlclean($_GET,'refnum',8,$connection);	$query['CheckList'] = "SELECT itm1,itm2,itm3,itm4,itm5,itm6,itm7,itm8,itm9,itm10"					.	",itm11,itm12,itm13,itm14,itm15,itm16,itm17,itm18,itm19,itm20"					.	" FROM {$TbleGrp['lists']} WHERE rank = {$_SESSION['curr_list']}";	if ($ListItms = @mysql_fetch_array(@mysql_query ($query['CheckList'], $connection)))	{	$full = 1;		for ($cntr = 1; (($full != 0) || ($cntr == 21)); $cntr++)		{	$name = "itm" . $cntr;			if (($ListItms[$name] == 0) || ($ListItms[$name] == $SongToAdd))	$full = 0;			$EmptyAt = $name;		}		if ($EmptyAt == 'itm21')			$m = "plfl";		elseif ($ListItms[$name] == $SongToAdd)			$m = "plhs";		else		{	$query['InsertSong'] = "UPDATE {$TbleGrp['lists']} SET {$EmptyAt} = {$SongToAdd} WHERE rank = {$_SESSION['curr_list']}";			if (@mysql_query($query['InsertSong'], $connection))			$m = "plad";	}	}header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&nxtaud={$_GET['nxtaud']}&m={$m}");exit;}	*//*elseif	($do == 'put'){	$query['GetNumCols'] = "SELECT numcol FROM pageinfo WHERE idnum={$idnum[0]}";	$Page = @mysql_fetch_array(@mysql_query($query['GetNumCols'], $connection));		$query['GetItms'] = "SELECT * FROM items WHERE idnum={$idnum[0]}";	$Itms = @mysql_fetch_array(@mysql_query($query['GetItms'], $connection));		$query['GetOrigRank'] = "SELECT rank FROM {$TbleGrp['uploads']} WHERE idnum={$idnum[0]} AND type='lst'";	if ($orig = @mysql_fetch_array(@mysql_query($query['GetOrigRank'], $connection)))	{	$query['DeleteOrig'] = "DELETE FROM {$TbleGrp['uploads']} WHERE rank={$orig['rank']}";		@mysql_query($query['DeleteOrig'], $connection);		for ($itmrep = 0; $itmrep < 8; $itmrep++)		{	for ($colrep = 0; $colrep < $Page['numcol']; $colrep++)			{	$name = "c{$colrep}i{$itmrep}";				if ($Itms[$name] == $orig['rank'])				{	$ExistsAt = $name;	break;			}	}			if (!(empty($ExistsAt))) break;	}	}			if (empty($ExistsAt))	{	for ($itmrep = 0; $itmrep < 8; $itmrep++)		{	for ($colrep = 0; $colrep < $Page['numcol']; $colrep++)			{	$name = "c{$colrep}i{$itmrep}";				if ($Itms[$name] == 0)				{	$EmptyAt = $name;	break;			}	}			if (!(empty($EmptyAt)))	break;	}	}		if (!(empty($ExistsAt)))	$WriteTo = $ExistsAt;	else						$WriteTo = $EmptyAt;		$query['AddToTble'] = "INSERT INTO {$TbleGrp['uploads']} SET idnum={$idnum[0]}, type='lst', file={$_SESSION['curr_list']}";	$query['GetNewRank'] = "SELECT rank FROM {$TbleGrp['uploads']} WHERE idnum={$idnum[0]} AND type='lst'";	if (@mysql_query($query['AddToTble'], $connection))	{	if ($new = @mysql_fetch_array(@mysql_query($query['GetNewRank'], $connection)))		{	$query['UpdateItems'] = "UPDATE items SET {$WriteTo}={$new['rank']} WHERE idnum={$idnum[0]}";			if (@mysql_query($query['UpdateItems'], $connection))			{	header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&m=plpt");	exit;	}	}	}							}*/?>