<?phprequire '../includes/mySQL_Sessions.inc';require '../includes/GetFileExtension.inc';require '../includes/UploadFileManip.inc';require '../includes/DirectoryRelated.inc';require '../includes/TableRelated.inc';session_start();	if (empty($_SESSION['idnum']))	{ die("No User Specified"); }$idnum[0] = $_SESSION['idnum'];$sess_id = session_id();$key = mktime();$TbleGrp = GenerateTableGroup($idnum[0]);$SendString = "?sess={$sess_id}&key={$key}&status=";if (empty($_FILES['ImgFile']['name'])){	header("Location: ../img/upload.php{$SendString}emp");	exit;}elseif (!(empty($_FILES['ImgFile']['name']))){	$pext = getFileExtension($_FILES['ImgFile']['name']);	$pext = strtolower($pext);	if (($pext != "jpg")  && ($pext != "jpeg"))		{	unlink($_FILES['ImgFile']['tmp_name']);			header("Location: ../img/upload.php{$SendString}ext");	exit;		}	$UploadDir = "/cluster/harry/img/photo/" . GenerateFullImageDirectoryPath($idnum[0]);	$FileName = "{$idnum[0]}.{$key}.jpg";		$UploadFile = $UploadDir . "drop/" . $FileName;	$OrigFile = $UploadDir . "orig." . $FileName;	$LargeFile = $UploadDir . "lrg." . $FileName;		if (move_uploaded_file($_FILES['ImgFile']['tmp_name'], $UploadFile))	{		$sh_Rename = "mv " . $UploadFile . " " . $OrigFile;		exec($sh_Rename);		ResizeImageFile( $OrigFile , $LargeFile , 640 , 80 );						$TargetFile = $UploadDir . "med." . $FileName;		ResizeImageFile( $LargeFile , $TargetFile , 460 , 80 );		$TargetFile = $UploadDir . "sml." . $FileName;		ResizeImageFile( $LargeFile , $TargetFile , 336 , 70 );		$TargetFile = $UploadDir . "thmb." . $FileName;		ResizeImageFile( $LargeFile , $TargetFile , 240 , 70 );		$TargetFile = $UploadDir . "mini." . $FileName;		ResizeImageFile( $LargeFile , $TargetFile , 180 , 70 );		$TargetFile = $UploadDir . "edit." . $FileName;		ResizeImageFile( $LargeFile , $TargetFile , 120 , 50 );					$sh_SetPerm =	"chmod a+rw " . $UploadDir . "lrg." . $FileName				."\n".	"chmod a+rw " . $UploadDir . "med." . $FileName				."\n".	"chmod a+rw " . $UploadDir . "sml." . $FileName				."\n".	"chmod a+rw " . $UploadDir . "thmb." . $FileName				."\n".	"chmod a+rw " . $UploadDir . "mini." . $FileName				."\n".	"chmod a+rw " . $UploadDir . "edit." . $FileName				."\n".	"chmod a+rw " . $UploadDir . "orig." . $FileName				;		exec($sh_SetPerm);		$query['StoreImage'] = "INSERT INTO {$TbleGrp['uploads']} SET idnum={$idnum[0]}, type='img',file={$key}, title='No Title', artist='No Photographer', cmnt='No Comment', ext='jpg'";$query['UpdateCount'] = "UPDATE filecount SET numpics = numpics + 1 WHERE idnum = '{$idnum[0]}'";$query['GetRank'] = "SELECT rank FROM {$TbleGrp['uploads']} WHERE idnum = {$idnum[0]} AND file = '{$key}'";					if (@mysql_query ($query['StoreImage'], $connection))		{	if (@mysql_query ($query['UpdateCount'], $connection))			{	if ($Ref = @mysql_fetch_array(@mysql_query ($query['GetRank'], $connection)))				{	$query['GetAlbum'] = "SELECT itm1";					for ($i = 2; $i <= 50; $i++)	$query['GetAlbum'] .= ", itm{$i}";					$query['GetAlbum'] .= " FROM {$TbleGrp['lists']} WHERE rank={$_SESSION['curr_alb']}";					if ($Alb = @mysql_fetch_array(@mysql_query ($query['GetAlbum'], $connection)))					{	for ($cntr = 1; $cntr <= 50; $cntr++)						{	$name = "itm" . $cntr;							if (empty($Alb[$name]))							{	$EmptyAt = $name;	break;						}	}						if	(!(empty($EmptyAt)))						{	$query['AddToAlb'] = "UPDATE {$TbleGrp['lists']} SET {$EmptyAt}={$Ref['rank']} WHERE rank={$_SESSION['curr_alb']}";							if (@mysql_query ($query['AddToAlb'], $connection))							{	header("Location: ../img/upload.php{$SendString}succ&rank={$Ref['rank']}");	exit;					}	}	}		}	}	}	}}header("Location: ../img/upload.php{$SendString}fail");	exit;?>