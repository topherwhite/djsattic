<?phprequire '../includes/mySQL_Sessions.inc';require '../includes/TableRelated.inc';session_start();	if (empty($_SESSION['idnum']))	{ die("No User Specified"); }$sess_id = session_id();$key = mktime();$clean['loc'] = ereg_replace('\'', '`', $_GET['loc']);$clean['th'] = ereg_replace('\'', '`', $_GET['th']);$clean['w'] = ereg_replace('\'', '`', $_GET['w']);$clean['lnk'] = ereg_replace('\'', '`', $_GET['lnk']);$clean['fr'] = ereg_replace('\'', '`', $_GET['fr']);$id = $_SESSION['idnum'];$them = mysqlclean($clean,'loc',8,$connection);$Rtrn = "?sess={$sess_id}&loc={$them}&w={$clean['w']}&th={$clean['th']}&lnk={$clean['lnk']}&m=";$TbleGrp['me'] = GenerateTableGroup($id);$TbleGrp['them'] = GenerateTableGroup($them);$query['chck_1'] = "SELECT rank FROM {$TbleGrp['me']['frnds']} WHERE idnum={$id} AND frnd={$them}";$query['chck_2'] = "SELECT rank FROM {$TbleGrp['them']['frnds']} WHERE idnum={$them} AND frnd={$id}";$query['req_1'] = "INSERT INTO {$TbleGrp['me']['frnds']} SET idnum={$id},frnd={$them},created={$key},"					.	"status=2,cmnt='waiting for authorization from frnd'";$query['req_2'] = "INSERT INTO {$TbleGrp['them']['frnds']} SET idnum={$them},frnd={$id},created={$key},"					.	"status=2,cmnt='waiting for authorization by this user'";$query['cntr_1'] = "UPDATE frnds.frndcount SET frnds_req=frnds_req+1 WHERE idnum={$them}";$query['cntr_2'] = "UPDATE frnds.frndcount SET frnds_pend=frnds_pend+1 WHERE idnum={$id}";$query['GetEmail'] = "SELECT email FROM login WHERE idnum={$them}";$query['GetNames']['me'] = "SELECT * FROM names WHERE idnum={$id}";$info = @mysql_fetch_array(@mysql_query($query['GetNames']['me'],$connection));//$query['SendMsg'] = "INSERT INTO {$TbleGrp['them']['msgs']} SET idnum={$clean['loc']}, sender={$_SESSION['idnum']}, status=2,"//				.	"created={$key, parent=0}";$subj = $info['firstname'] . " " . $info['lastname'] . " has requested to be your mySimum friend!";$msg = "\n{$subj}\nTo approve this friendship click the link below:\n"		.	"http://www.mysimum.com/frnd/frnd_appr.php?id=".dechex($them)."&fr=".dechex($id)."&do=ap";if (($chck1 = @mysql_query($query['chck_1'],$connection)) && ($chck2 = @mysql_query($query['chck_2'],$connection))){	$check1 = @mysql_fetch_array($chck1);	$check2 = @mysql_fetch_array($chck2);		if ((empty($check1)) && (empty($check2)))	{	if ((@mysql_query($query['req_1'],$connection)) && (@mysql_query($query['req_2'],$connection)))		{	if ((@mysql_query($query['cntr_1'],$connection)) && (@mysql_query($query['cntr_2'],$connection)))			{	$info = @mysql_fetch_array(@mysql_query($query['GetEmail'],$connection));				if (mail($info['email'],$subj,$msg,"From: services"))				{						header("Location: ../user/infobox.php{$Rtrn}frreq");		exit;				}			}		}	}	else	{	header("Location: ../user/infobox.php{$Rtrn}alrfr");	exit;	}}else{	header("Location: ../user/infobox.php{$Rtrn}frreqfl");	exit;	}?>