<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="content-type" content="text/html;charset=utf-8" /><?phprequire '../includes/mySQL_Sessions.inc';require '../includes/TableRelated.inc';require '../includes/ThemeGen.inc';require '../msg/msg_page_dim.inc';require '../includes/DirectoryRelated.inc';session_start();	if (empty($_SESSION['idnum']))	{ die("No User Specified"); }$idnum[0] = $_SESSION['idnum'];$sess_id = session_id();$key = dechex(mktime());$thisdate = date("mdY",mktime());$TbleGrp = GenerateTableGroup($idnum[0]);$bg_color = $_SESSION['bg'];$ThemeColor = dechex($_SESSION['r']).dechex($_SESSION['g']).dechex($_SESSION['b']);$MessageColor = ColorOffset($ThemeColor,(-112));$SelectColor = ColorOffset($ThemeColor,(-72));$BorderColor = ColorOffset($ThemeColor,(-92));$HiLiteColor = ColorOffset($ThemeColor,18);$width = $Frame["msglist_w"] - 4;$height = $Frame["msglist_h"] - 4;$bgcolor = $Frame['bg'];$clean['slct'] = ereg_replace('\'', '`', $_GET['slct']);$clean['stat'] = ereg_replace('\'', '`', $_GET['stat']);$clean['bx'] = ereg_replace('\'', '`', $_GET['bx']);$slct = mysqlclean($clean,"slct",8,$connection);$clean['ord'] = ereg_replace('\'', '`', $_GET['ord']);if ($clean['stat'] == 2){	$query['UpdateStatus'] = "UPDATE {$TbleGrp['msgs_rec']} SET status=1 WHERE rank={$slct}";	$query['UpdateCount'] = "UPDATE msgs.msgcount SET msgs_rec_unread=msgs_rec_unread-1 WHERE idnum={$idnum[0]}";	@mysql_query($query['UpdateStatus'],$connection);	@mysql_query($query['UpdateCount'],$connection);	$_SESSION['msgs'] = $_SESSION['msgs']-1;}if (empty($clean['ord']) || ($clean['ord'] == 'dt'))	$ord = "created";if ($clean['bx'] == 'in'){	$query['getmsgs'] = "SELECT rank, sender, status, type, subject, refnum, created FROM {$TbleGrp['msgs_rec']} WHERE idnum={$idnum[0]} ORDER BY {$ord}";	$query['msgcount'] = "SELECT msgs_rec_total FROM msgs.msgcount WHERE idnum={$idnum[0]} LIMIT 1";	if ($cnt =  @mysql_fetch_array(@mysql_query($query['msgcount'],$connection)))	{	if ($getmsg = @mysql_query($query['getmsgs'],$connection))		{	for ($i = $cnt['msgs_rec_total']; $i >= 1; $i--)			{	$msg[$i] = @mysql_fetch_array($getmsg);						if (date("mdY",$msg[$i]['created']) == $thisdate)	$date[$i] = date("g:i a",$msg[$i]['created']);				else												$date[$i] = date("M d",$msg[$i]['created']);							if ($msg[$i]['rank'] == $slct)				{	$query['getbody'] = "SELECT body FROM {$TbleGrp['msgs_body']} WHERE rank={$msg[$i]['refnum']}";					$txt =  @mysql_fetch_array(@mysql_query($query['getbody'],$connection));				 	$txt['subj'] = $msg[$i]['subject'];				 					 	if ($msg[$i]['sender'] == 16777200)		$FilePath = "../static/rhino.png";				 	else				 	{	$query['GetPic'] = "SELECT prof_pic FROM pageinfo WHERE idnum={$msg[$i]['sender']} LIMIT 1";				 		$Pic = @mysql_fetch_array(@mysql_query($query['GetPic'], $connection));				 		$lnk = MakeCurrLocLinks($msg[$i]['sender'],GenerateFullImageDirectoryPath($msg[$i]['sender']),$_SESSION['tmpdir']);				 		$FileDir = "../tmp/img/{$lnk}/";						$SmallFilePath = "{$FileDir}edit.{$msg[$i]['sender']}.{$Pic['prof_pic']}.jpg";						$dim = getimagesize($SmallFilePath);						if ($dim[0] > $dim[1])	{	$img_horiz = 127;	$img_vert = (127*($dim[1]/$dim[0]));												$ypos = round((127-$img_vert)/2)+2;			$xpos = 1;		}						else					{	$img_horiz = (127*($dim[0]/$dim[1]));	$img_vert = 127;												$ypos = 1;			$xpos = round((127-$img_horiz)/2)+2;		}						$FilePath = "{$FileDir}mini.{$msg[$i]['sender']}.{$Pic['prof_pic']}.jpg";						if (empty($dim[0]))		$FilePath = "../static/dflt_prfpic.png";					}				}							if ($msg[$i]['sender'] == 16777200)		$name[$i]['fullname'] = "mySimum Services";				else				{	$query['getname'] = "SELECT concat(firstname, ' ', lastname) AS fullname FROM names WHERE idnum={$msg[$i]['sender']}";					$name[$i] = @mysql_fetch_array(@mysql_query($query['getname'],$connection));				}	}	}	}$msgcnt = $cnt['msgs_rec_total'];}	elseif ($clean['bx'] == 'out'){	$query['msgcount'] = "SELECT msgs_snt FROM msgs.msgcount WHERE idnum={$idnum[0]} LIMIT 1";	$query['getmsgs'] = "SELECT rank, sentto, type, subject, refnum, created FROM {$TbleGrp['msgs_snt']} WHERE idnum={$idnum[0]} ORDER BY {$ord}";	if ($cnt =  @mysql_fetch_array(@mysql_query($query['msgcount'],$connection)))	{	if ($getmsg = @mysql_query($query['getmsgs'],$connection))		{	for ($i = $cnt['msgs_snt']; $i >= 1; $i--)			{	$msg[$i] = @mysql_fetch_array($getmsg);						if (date("mdY",$msg[$i]['created']) == $thisdate)	$date[$i] = date("g:i a",$msg[$i]['created']);				else												$date[$i] = date("M d",$msg[$i]['created']);							if ($msg[$i]['rank'] == $slct)				{	$query['getbody'] = "SELECT body FROM {$TbleGrp['msgs_body']} WHERE rank={$msg[$i]['refnum']}";					$txt =  @mysql_fetch_array(@mysql_query($query['getbody'],$connection));				 	$txt['subj'] = $msg[$i]['subject'];				 					 					 	$query['GetPic'] = "SELECT prof_pic FROM pageinfo WHERE idnum={$msg[$i]['sentto']} LIMIT 1";				 	$Pic = @mysql_fetch_array(@mysql_query($query['GetPic'], $connection));				 	$lnk = MakeCurrLocLinks($msg[$i]['sentto'],GenerateFullImageDirectoryPath($msg[$i]['sentto']),$_SESSION['tmpdir']);				 	$FileDir = "../tmp/img/{$lnk}/";					$SmallFilePath = "{$FileDir}edit.{$msg[$i]['sentto']}.{$Pic['prof_pic']}.jpg";					$dim = getimagesize($SmallFilePath);					if ($dim[0] > $dim[1])	{	$img_horiz = 127;	$img_vert = (127*($dim[1]/$dim[0]));												$ypos = round((127-$img_vert)/2)+2;			$xpos = 1;		}					else					{	$img_horiz = (127*($dim[0]/$dim[1]));	$img_vert = 127;												$ypos = 1;			$xpos = round((127-$img_horiz)/2)+2;		}					$FilePath = "{$FileDir}mini.{$msg[$i]['sentto']}.{$Pic['prof_pic']}.jpg";					if (empty($dim[0]))		$FilePath = "../static/dflt_prfpic.png";				}							$query['getname'] = "SELECT concat(firstname, ' ', lastname) AS fullname FROM names WHERE idnum={$msg[$i]['sentto']}";				$name[$i] = @mysql_fetch_array(@mysql_query($query['getname'],$connection));	}	}	}$msgcnt = $cnt['msgs_snt'];}elseif ($clean['bx'] == 'arc'){	$query['getmsgs'] = "SELECT rank, sender, status, type, subject, refnum, created FROM {$TbleGrp['msgs_arc']} WHERE idnum={$idnum[0]} ORDER BY {$ord}";	$query['msgcount'] = "SELECT msgs_archived FROM msgs.msgcount WHERE idnum={$idnum[0]} LIMIT 1";	if ($cnt =  @mysql_fetch_array(@mysql_query($query['msgcount'],$connection)))	{	if ($getmsg = @mysql_query($query['getmsgs'],$connection))		{	for ($i = $cnt['msgs_archived']; $i >= 1; $i--)			{	$msg[$i] = @mysql_fetch_array($getmsg);						$date[$i] = date("M d",$msg[$i]['created']);							if ($msg[$i]['rank'] == $slct)				{	$query['getbody'] = "SELECT body FROM {$TbleGrp['msgs_body']} WHERE rank={$msg[$i]['refnum']}";					$txt =  @mysql_fetch_array(@mysql_query($query['getbody'],$connection));				 	$txt['subj'] = $msg[$i]['subject'];				 					 	if ($msg[$i]['sender'] == 16777200)		$FilePath = "../static/rhino.png";				 	else				 	{	$query['GetPic'] = "SELECT prof_pic FROM pageinfo WHERE idnum={$msg[$i]['sender']} LIMIT 1";				 		$Pic = @mysql_fetch_array(@mysql_query($query['GetPic'], $connection));				 		$lnk = MakeCurrLocLinks($msg[$i]['sender'],GenerateFullImageDirectoryPath($msg[$i]['sender']),$_SESSION['tmpdir']);				 		$FileDir = "../tmp/img/{$lnk}/";						$SmallFilePath = "{$FileDir}edit.{$msg[$i]['sender']}.{$Pic['prof_pic']}.jpg";						$dim = getimagesize($SmallFilePath);						if ($dim[0] > $dim[1])	{	$img_horiz = 127;	$img_vert = (127*($dim[1]/$dim[0]));												$ypos = round((127-$img_vert)/2)+2;			$xpos = 1;		}						else					{	$img_horiz = (127*($dim[0]/$dim[1]));	$img_vert = 127;												$ypos = 1;			$xpos = round((127-$img_horiz)/2)+2;		}						$FilePath = "{$FileDir}mini.{$msg[$i]['sender']}.{$Pic['prof_pic']}.jpg";						if (empty($dim[0]))		$FilePath = "../static/dflt_prfpic.png";					}				}							if ($msg[$i]['sender'] == 16777200)		$name[$i]['fullname'] = "mySimum Services";				else				{	$query['getname'] = "SELECT concat(firstname, ' ', lastname) AS fullname FROM names WHERE idnum={$msg[$i]['sender']}";					$name[$i] = @mysql_fetch_array(@mysql_query($query['getname'],$connection));				}	}	}	}$msgcnt = $cnt['msgs_archived'];}$txt['hz'] = 131;echo "<style>"	." div, textarea{position:absolute;left:2px;border:none;background-color:transparent;}"		." textarea{"."padding:".round($pad/2)."px {$pad}px 0px {$pad}px;top:1px;font:14px arial;width:".round($buffer+$width-$pad-$pad-$txt['hz'])."px;background-color:#{$ThemeColor};"."}"		." textarea.subj{"."left:131px;top:{$subj['vert']}px;padding-top:".round($pad/3)."px;height:".round($subj['ht']-($pad/3))."px;font:bold 16px arial;"."}"	." textarea.msg{"."left:{$txt['hz']}px;height:".round($body['ht']-($pad/2))."px;top:{$body['vert']}px;"."}"		." img.prf{"."z-index:2;position:absolute;top:{$ypos}px;left:{$xpos}px;width:{$img_horiz}px;height:{$img_vert}px;"."}"		." div.bttn{"."top:{$bttn['vert']}px;width:{$width}px;height:{$bttn['ht']}px;background-color:#{$ThemeColor};"."}"	." div.top{"."background-color:#{$ThemeColor};border-bottom:solid 2px #{$BorderColor};top:{$listHd['vert']}px;width:{$width}px;height:{$listHd['ht']}px;"."}"	." div.from, div.date, div.subj, div.del, div.ar {"."top:5px;text-align:left;font:14px arial;"."}"	." div.from{"."width:".(190)."px;left:".(10)."px;"."}"	." div.date{"."width:".(90)."px;left:".($width-200)."px;text-align:right;"."}"	." div.ar{"."width:".(45)."px;left:".($width-100)."px;text-align:right;cursor:pointer;"."}"	." div.del{"."width:".(45)."px;left:".($width-50)."px;text-align:right;cursor:pointer;"."}"	." div.subj{"."width:".($width-100-200)."px;left:".(210)."px;"."}"		." div.msgs{"."background-color:#{$ThemeColor};cursor:pointer;border-bottom:solid 1px #{$BorderColor};width:{$width}px;height:{$msgHeight}px;"."}"		." div.msgs:hover{"."background-color:#{$HiLiteColor};"."}"	." div.in, div.out, div.arc {"."cursor:pointer;height:24px;width:236px;top:0px;"."}"	;if ($clean['bx'] == 'in')echo " div.in{". "left:0px;background:url(../static/bttn/msgs/inbox.h.png);" ."}";elseecho " div.in{". "left:0px;background:url(../static/bttn/msgs/inbox.png);" ."}"	." div.in:hover {"."background:url(../static/bttn/msgs/inbox.h.png);"."}";if ($clean['bx'] == 'out')echo " div.out{". "left:236px;background:url(../static/bttn/msgs/outbox.h.png);" ."}";elseecho " div.out{". "left:236px;background:url(../static/bttn/msgs/outbox.png);" ."}"	." div.out:hover {"."background:url(../static/bttn/msgs/outbox.h.png);"."}";if ($clean['bx'] == 'arc')echo " div.arc{". "left:472px;background:url(../static/bttn/msgs/archive.h.png);" ."}";elseecho " div.arc{". "left:472px;background:url(../static/bttn/msgs/archive.png);" ."}"	." div.arc:hover {"."background:url(../static/bttn/msgs/archive.h.png);"."}";	echo "</style>";?><?php//echo "</head><body style=\"background-color:#{$BorderColor};\"";echo "</head><body style=\"background-color:transparent;\"";if (!(empty($_GET['m']))){	echo " onLoad=\"top.console.location='../user/console.php?th={$ThemeColor}&key={$key}&m={$_GET['m']}';";}else	echo ">";echo "<textarea class=\"subj\" readonly>"	.$txt['subj']	."</textarea>"	."<textarea class=\"msg\" readonly>"	.$txt['body']	."</textarea>"	."<img class=\"prf\" src=\"{$FilePath}\" />"	."<div class=\"bttn\">"	."<div class=\"in\" onClick=\"top.location='../msg/msg.php?sess={$sess_id}&bx=in';\"></div>"	."<div class=\"out\" onClick=\"top.location='../msg/msg.php?sess={$sess_id}&bx=out';\"></div>"	."<div class=\"arc\" onClick=\"top.location='../msg/msg.php?sess={$sess_id}&bx=arc';\"></div>"	."</div>"	."<div class=\"top\">"	."<div style=\"font:bold 18px arial;top:2px;\" class=\"date\">Sent</div>"	."<div style=\"font:bold 18px arial;top:2px;\" class=\"from\">";if ($clean['box'] == 'out')	echo "Sent To";else						echo "Sent By";echo "</div>"	."<div style=\"font:bold 18px arial;top:2px;\" class=\"subj\">Subject</div>"	."</div>"	;	for ($i = 1; $i <= $msgcnt; $i++){	$Snd = "?sess={$sess_id}&slct={$msg[$i]['rank']}&stat={$msg[$i]['status']}&bx={$clean['bx']}";	if ($msg[$i]['status'] == 2)	$unread[$i] = "font-weight:bold;";		if ($msg[$i]['rank'] == $slct)		$slctd[$i] = "background-color:#{$SelectColor};";	else								$clklnk[$i] = "top.msglist.location='../msg/msglist.php{$Snd}';";	echo "<div class=\"msgs\" style=\"top:".($listHd['vert'] + 26*$i)."px;{$slctd[$i]}\" onClick=\"{$clklnk[$i]}\">"		."<div class=\"from\" style=\"{$unread[$i]}\">{$name[$i]['fullname']}</div>"		."<div class=\"subj\" style=\"{$unread[$i]}\">{$msg[$i]['subject']}</div>"		."<div class=\"date\" style=\"{$unread[$i]}\">{$date[$i]}</div>"		."</div>"		."<div class=\"del\" style=\"top:".($listHd['vert'] + 26*$i + 5)."px;\"" 		.	"onClick=\"top.msglist.location='../msg/msg_del.php{$Snd}';\">Delete</div>"		;	if ($clean['bx'] != 'arc')			echo "<div class=\"ar\" style=\"top:".($listHd['vert'] + 26*$i + 5)."px;\"" 		.	"onClick=\"top.msglist.location='../msg/msg_arc.php{$Snd}';\">Archive</div>";}?></body></html>