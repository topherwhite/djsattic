<?phprequire '../includes/MySQL_Sessions.inc';require '../includes/TableRelated.inc';session_start();	if (empty($_SESSION['idnum']))	{ die("No User Specified"); }$idnum[0] = $_SESSION['idnum'];$sess_id = session_id();$key = mktime();$TbleGrp = GenerateTableGroup($idnum[0]);$do = mysqlclean($_GET,'do',4,$connection);if		($do == 'chng'){	$_SESSION['curr_list'] = mysqlclean($_GET,'refnum',8,$connection);	header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&m=plch");	exit;}elseif	($do == 'make'){	$query['UpdateCount'] = "UPDATE filecount SET audlists=audlists+1 WHERE idnum={$idnum[0]}";	$query['CreateList'] = "INSERT INTO {$TbleGrp['lists']} SET idnum={$idnum[0]}, type='aud', title='Untitled Playlist', created={$key}";	$query['GetLastID'] = "SELECT MAX(rank) AS last FROM {$TbleGrp['lists']} WHERE idnum = {$idnum[0]}";	if (@mysql_query($query['UpdateCount'], $connection))	{	if (@mysql_query($query['CreateList'], $connection))		{	if ($id = @mysql_fetch_array(@mysql_query($query['GetLastID'], $connection)))			{			$_SESSION['curr_list'] = $id['last'];			header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&m=plcr");			exit;	}	}	}}elseif	($do == 'del'){	$query['UpdateCount'] =	"UPDATE filecount SET audlists = audlists - 1 WHERE idnum = {$idnum[0]}";	$query['DeleteList'] =	"DELETE FROM {$TbleGrp['lists']} WHERE rank = {$_SESSION['curr_list']}";	if (@mysql_query($query['UpdateCount'], $connection))	{	if (@mysql_query($query['DeleteList'], $connection))		{	$query['FirstList'] = "SELECT rank FROM {$TbleGrp['lists']} WHERE idnum = {$idnum[0]} AND type = 'aud' LIMIT 1";			if ($List = @mysql_fetch_array(@mysql_query($query['FirstList'],$connection)))			{	$_SESSION['curr_list'] = $List['rank'];				header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&m=pldl");				exit;}	}	}	}elseif	($do == 'ttl'){	$clean['LstTtl'] = ereg_replace('\'', '`', $_POST['LstTtl']);	$title = mysqlclean($clean,'LstTtl',50,$connection);	$query['UpdateTitle'] =	"UPDATE {$TbleGrp['lists']} SET title = '{$title}' WHERE rank = {$_SESSION['curr_list']}";	if (@mysql_query($query['UpdateTitle'], $connection))	{	header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&m=plrn");		exit;}	}elseif	($do == 'rem'){	$SongToRemove = mysqlclean($_GET,'refnum',8,$connection);	$query['CheckList'] = "SELECT itm1,itm2,itm3,itm4,itm5,itm6,itm7,itm8,itm9,itm10"					.	",itm11,itm12,itm13,itm14,itm15,itm16,itm17,itm18,itm19,itm20"					.	" FROM {$TbleGrp['lists']} WHERE rank = {$_SESSION['curr_list']}";	if ($ListItms = @mysql_fetch_array(@mysql_query ($query['CheckList'], $connection)))	{	for ($cntr = 1; $cntr <= 20; $cntr++)		{	$name = "itm" . $cntr;			if ($ListItms[$name] == $SongToRemove)				$RemoveFrom = $cntr;			}		if (empty($RemoveFrom))			$status = "notthere";		else		{	$query['RemoveSong'] = "UPDATE {$TbleGrp['lists']} SET itm{$RemoveFrom} = 0 WHERE rank = {$_SESSION['curr_list']}";			if (@mysql_query($query['RemoveSong'], $connection))			$status = "succ";	}	}	if (($status == 'succ') && ($RemoveFrom < 20))	{	$query['ReOrg'] .= "UPDATE {$TbleGrp['lists']} SET";		for ($cntr = $RemoveFrom; $cntr < 20; $cntr++)		{	$query['ReOrg'] .= " itm{$cntr}=itm" . ($cntr+1);			if ($cntr < 19)	$query['ReOrg'] .= ",";		}		$query['ReOrg'] .= " WHERE rank={$_SESSION['curr_list']}";		if (@mysql_query($query['ReOrg'], $connection))			$status = "reorg";	}	header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&nxtaud={$_GET['nxtaud']}&m=plrm");	exit;}elseif	(($do == 'mvU') || ($do == 'mvD')){	$SongToMove = mysqlclean($_GET,'refnum',8,$connection);	$query['CheckList'] = "SELECT itm1,itm2,itm3,itm4,itm5,itm6,itm7,itm8,itm9,itm10"					.	",itm11,itm12,itm13,itm14,itm15,itm16,itm17,itm18,itm19,itm20"					.	" FROM {$TbleGrp['lists']} WHERE rank = {$_SESSION['curr_list']}";	if ($ListItms = @mysql_fetch_array(@mysql_query ($query['CheckList'], $connection)))	{	for ($cntr = 1; $ListItms[$name] != $SongToMove; $cntr++)		{	$name = "itm{$cntr}";			if ($ListItms[$name] == $SongToMove)			{	if (($do == 'mvU') && ($cntr != 1))		$dest = "itm" . ($cntr-1);				elseif (($do == 'mvD') && ($cntr != 20))	$dest = "itm" . ($cntr+1);				$query['Move'] = "UPDATE {$TbleGrp['lists']} SET {$name}={$dest}, {$dest}={$SongToMove} WHERE rank={$_SESSION['curr_list']}";	}	}	}		if (!(empty($query['Move'])))	{	if (@mysql_query ($query['Move'], $connection))			$status = "moved";	}	header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&m=p{$do}");	exit;}elseif	($do == 'add'){	$SongToAdd = mysqlclean($_GET,'refnum',8,$connection);	$query['CheckList'] = "SELECT itm1,itm2,itm3,itm4,itm5,itm6,itm7,itm8,itm9,itm10"					.	",itm11,itm12,itm13,itm14,itm15,itm16,itm17,itm18,itm19,itm20"					.	" FROM {$TbleGrp['lists']} WHERE rank = {$_SESSION['curr_list']}";	if ($ListItms = @mysql_fetch_array(@mysql_query ($query['CheckList'], $connection)))	{	$full = 1;		for ($cntr = 1; (($full != 0) || ($cntr == 21)); $cntr++)		{	$name = "itm" . $cntr;			if (($ListItms[$name] == 0) || ($ListItms[$name] == $SongToAdd))	$full = 0;			$EmptyAt = $name;		}		if ($EmptyAt == 'itm21')			$m = "plfl";		elseif ($ListItms[$name] == $SongToAdd)			$m = "plhs";		else		{	$query['InsertSong'] = "UPDATE {$TbleGrp['lists']} SET {$EmptyAt} = {$SongToAdd} WHERE rank = {$_SESSION['curr_list']}";			if (@mysql_query($query['InsertSong'], $connection))			$m = "plad";	}	}header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&nxtaud={$_GET['nxtaud']}&m={$m}");exit;}			elseif	($do == 'put'){	$query['GetNumCols'] = "SELECT numcol FROM pageinfo WHERE idnum={$idnum[0]}";	$Page = @mysql_fetch_array(@mysql_query($query['GetNumCols'], $connection));		$query['GetItms'] = "SELECT * FROM items WHERE idnum={$idnum[0]}";	$Itms = @mysql_fetch_array(@mysql_query($query['GetItms'], $connection));		$query['GetOrigRank'] = "SELECT rank FROM {$TbleGrp['uploads']} WHERE idnum={$idnum[0]} AND type='lst'";	if ($orig = @mysql_fetch_array(@mysql_query($query['GetOrigRank'], $connection)))	{	$query['DeleteOrig'] = "DELETE FROM {$TbleGrp['uploads']} WHERE rank={$orig['rank']}";		@mysql_query($query['DeleteOrig'], $connection);		for ($itmrep = 0; $itmrep < 8; $itmrep++)		{	for ($colrep = 0; $colrep < $Page['numcol']; $colrep++)			{	$name = "c{$colrep}i{$itmrep}";				if ($Itms[$name] == $orig['rank'])				{	$ExistsAt = $name;	break;			}	}			if (!(empty($ExistsAt))) break;	}	}			if (empty($ExistsAt))	{	for ($itmrep = 0; $itmrep < 8; $itmrep++)		{	for ($colrep = 0; $colrep < $Page['numcol']; $colrep++)			{	$name = "c{$colrep}i{$itmrep}";				if ($Itms[$name] == 0)				{	$EmptyAt = $name;	break;			}	}			if (!(empty($EmptyAt)))	break;	}	}		if (!(empty($ExistsAt)))	$WriteTo = $ExistsAt;	else						$WriteTo = $EmptyAt;		$query['AddToTble'] = "INSERT INTO {$TbleGrp['uploads']} SET idnum={$idnum[0]}, type='lst', file={$_SESSION['curr_list']}";	$query['GetNewRank'] = "SELECT rank FROM {$TbleGrp['uploads']} WHERE idnum={$idnum[0]} AND type='lst'";	if (@mysql_query($query['AddToTble'], $connection))	{	if ($new = @mysql_fetch_array(@mysql_query($query['GetNewRank'], $connection)))		{	$query['UpdateItems'] = "UPDATE items SET {$WriteTo}={$new['rank']} WHERE idnum={$idnum[0]}";			if (@mysql_query($query['UpdateItems'], $connection))			{	header("Location: playlist_curr.php?sess={$sess_id}&key={$key}&m=plpt");	exit;	}	}	}							}?>