<?phprequire_once '../../includes/mySQL_Sessions.inc';require_once '../../includes/TableRelated.inc';function ResizeImageFile($source,$target,$newdim,$quality){	$src_img = ImageCreateFromJPEG($source);	$dim['x'] = ImageSx($src_img);	$dim['y'] = ImageSy($src_img);	if ( $dim['x'] >= $dim['y'] )	{	$new['x'] = $newdim;	$new['y'] = $newdim/($dim['x']/$dim['y']);	}	else							{	$new['y'] = $newdim;	$new['x'] = $newdim/($dim['y']/$dim['x']);	}	$new_img = ImageCreateTrueColor($new['x'],$new['y']);	ImageCopyResampled($new_img,$src_img,0,0,0,0,$new['x'],$new['y'],$dim['x'],$dim['y']);	ImageJPEG($new_img,$target,$quality);	return true;}function GenDirPath($id){	for ($rep = 1; empty($SubDir); $rep++)	{	$up=16777200-(400*($rep-1)); $lw=16777200-(400*$rep);		if (($id <= $up) && ($id > $lw)) $SubDir="{$lw}_{$up}";  }	for ($rep = 1; empty($MstrDir); $rep++)	{	$up=16777200-(160000*($rep-1));	$lw=16777200-(160000*$rep);	if (($id <= $up) && ($id > $lw)) $MstrDir="{$lw}_{$up}"; }	return ("{$MstrDir}/{$SubDir}/{$id}/");}session_start();	if (empty($_SESSION['idnum']))	{ die("No User Specified"); }$sess_id = session_id();$key = mktime();$TbleGrp = GenerateTableGroup($_SESSION['idnum']);if (!(empty($_POST['title']))){ $clean['title'] = str_replace('\'', '`', $_POST['title']);	 $title = mysqlclean($clean,'title',50,$connection);	}if (!(empty($_POST['artist']))){ $clean['artist'] = str_replace('\'', '`', $_POST['artist']);	 $artist = mysqlclean($clean,'artist',50,$connection);	}if (!(empty($_POST['album']))){ $clean['album'] = str_replace('\'', '`', $_POST['album']);	 $album = mysqlclean($clean,'album',50,$connection);	}if (!(empty($_POST['genreSel']))){ $clean['genre'] = str_replace('\'', '`', $_POST['genreSel']); $genre = mysqlclean($clean,'genre',25,$connection);	}//if (!(empty($_POST['genre'])))//{	$clean['genre'] = str_replace('\'', '`', $_POST['genre']);	 $genre = mysqlclean($clean,'genre',25,$connection);	}if (!(empty($_POST['trck']))){ $clean['trck'] = intval($_POST['trck']);		 				 $trck = mysqlclean($clean,'trck',3,$connection);		}if (!(empty($_POST['cmnt']))){ $clean['cmnt'] = str_replace('\'', '`', $_POST['cmnt']);		 $cmnt = mysqlclean($clean,'cmnt',300,$connection);		}$clean['refnum'] = str_replace('\'', '`', $_GET['refnum']);$refnum = mysqlclean($clean,'refnum',8,$connection);$query['GetMeta'] = "SELECT title,artist,album,genre,trck,cmnt,MD5artist,MD5album FROM {$TbleGrp['uploads']} WHERE rank={$refnum}";	if ($Meta = @mysql_fetch_array(@mysql_query($query['GetMeta'], $connection))){	if (($title != $Meta['title']) && (!(empty($title))))		$write['title'] = "title='{$title}', ";	else														$write['title'] = "";	if (($artist != $Meta['artist']) && (!(empty($artist))))	$write['artist'] = "artist='{$artist}', MD5artist=md5(lower(trim('{$artist}'))), ";	else														$write['artist'] = "";	if (($album != $Meta['album']) && (!(empty($album))))		$write['album'] = "album='{$album}', MD5album=md5(lower(trim('{$album}'))), ";	else														$write['album'] = "";	if (($genre != $Meta['genre']) && (!(empty($genre))))		$write['genre'] = "genre='{$genre}', MD5genre=md5(lower(trim('{$genre}'))), ";	else														$write['genre'] = "";		if (($trck != $Meta['trck']) && (!(empty($trck))))			$write['trck'] = "trck={$trck}, ";	else														$write['trck'] = "";	if (($cmnt != $Meta['cmnt']) && (!(empty($cmnt))))			$write['cmnt'] = "cmnt='{$cmnt}', ";	else														$write['cmnt'] = "";	$query['WriteMeta'] = "UPDATE {$TbleGrp['uploads']} SET " . $write['title'] . $write['artist'] . $write['album']												. $write['genre'] . $write['trck'] . $write['cmnt'] . "type='aud' WHERE rank={$refnum}";		if (@mysql_query($query['WriteMeta'],$connection))	{	if (($artist != $Meta['artist']) || ($album != $Meta['album']))		{	$query['ChckAlbTble'] = "SELECT rank FROM {$TbleGrp['albms']} WHERE idnum={$_SESSION['idnum']} AND "							.	"MD5s=concat(md5(lower(trim('{$artist}'))),'_',md5(lower(trim('{$album}'))))";			$Chck = @mysql_fetch_array(@mysql_query($query['ChckAlbTble'], $connection));			if (empty($Chck['rank']))			{	$query['MakeAlbEntry'] = "INSERT INTO {$TbleGrp['albms']} SET idnum={$_SESSION['idnum']}, "									.	"MD5s=concat(md5(lower(trim('{$artist}'))),'_',md5(lower(trim('{$album}'))))";				@mysql_query($query['MakeAlbEntry'],$connection);			}			$query['StillExist'] = "SELECT rank FROM {$TbleGrp['uploads']} WHERE idnum={$_SESSION['idnum']} AND type='aud'"							.	"AND MD5album='{$Meta['MD5album']}' AND MD5artist='{$Meta['MD5artist']}'";			$StillExist = @mysql_fetch_array(@mysql_query($query['StillExist'], $connection));			if (empty($StillExist['rank']))			{	$query['DeleteOldAlb'] = "DELETE FROM {$TbleGrp['albms']} WHERE idnum={$_SESSION['idnum']} AND "								.	"MD5s='{$Meta['MD5artist']}_{$Meta['MD5album']}'";				@mysql_query($query['DeleteOldAlb'],$connection);			}	}	}		if (!(empty($_FILES['albart']['name'])))	{	$str = $_FILES['albart']['name'];		$pext = strtolower(substr($str,strrpos($str,".")+1,strlen($str)-strrpos($str,".")));		if (($pext != 'jpg') && ($pext != 'jpeg'))			unlink($_FILES['albart']['tmp_name']);		else		{	$UploadDir = "/cluster/harry/img/photo/" . GenDirPath($_SESSION['idnum']) . "alb/";			$UploadTempFile = "{$UploadDir}{$key}.tmp.alb.{$pext}";			$UploadFile = "{$UploadDir}{$key}.alb.{$pext}";			$sh_DeleteTemp = "rm {$UploadTempFile}";			$sh_SetPerm = "chmod a+rw {$UploadFile}";			if (move_uploaded_file($_FILES['albart']['tmp_name'], $UploadTempFile))			{	if (ResizeImageFile($UploadTempFile,$UploadFile,90,80))					exec($sh_DeleteTemp);					exec($sh_SetPerm);				$query['AddAlbArt'] = "UPDATE {$TbleGrp['albms']} SET graphic=1, name={$key}, ext='{$pext}' "					.	"WHERE idnum={$_SESSION['idnum']} AND "					."MD5s=concat(md5(lower(trim('{$artist}'))),'_',md5(lower(trim('{$album}'))))";				@mysql_query($query['AddAlbArt'], $connection);					}	}	}	header("Location: ../meta/meta_edit.php?sess={$sess_id}&key={$key}&refnum={$refnum}&ed=y");exit;}		?>